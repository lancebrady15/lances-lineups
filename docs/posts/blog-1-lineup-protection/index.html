<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.41">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lance Brady">
<meta name="dcterms.date" content="2025-02-18">

<title>Blog Post #1: Lineup Protection or Lineup Penalty? – Lance’s Lineups</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-48ffa3e5b9d089919c6712c39e5b00f2.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-79108a0fc1995748cbd19a5b0e3e3e7c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Lance’s Lineups</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../data.html"> 
<span class="menu-text">Data</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/lance-brady-979b4a196/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/lancebrady15/lances-lineups"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Blog Post #1: Lineup Protection or Lineup Penalty?</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">lineup protection</div>
                <div class="quarto-category">lineups</div>
                <div class="quarto-category">statcast</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Lance Brady </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 18, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="takeaways" class="level2">
<h2 class="anchored" data-anchor-id="takeaways">Takeaways</h2>
<ol type="1">
<li>The next batter’s xwOBA does have a small but significant impact on the current plate appearance’s xwOBA, and this effect is negative. A stronger on-deck hitter results in lower than expected outcomes for that plate appearance.</li>
<li>Some of the league’s best pitchers perform better when a strong hitter is on deck, serving as an indication of mental aptitude or ability to elevate in high-leverage moments that makes them so successful. This suggests that lineup protection may not be a universal phenomenon and that individual pitchers may have different responses to it.</li>
<li>While we see evidence pointing to fewer walks, more strikeouts, and fewer extra base hits with better <code>next_batter_xwOBA</code>, we cannot conclusively point to the next batter’s xwOBA as the cause of these effects.</li>
<li>Even when controlling for batter skill, matchup effects, and game state, a higher next_batter_xwOBA is associated with a small but statistically significant decrease in the current batter’s expected batting average (xBA) for that plate appearance. If the next batter’s xwOBA goes up by 0.100, we estimate a ~-0.003 reduction in pa_xBA per plate appearance—over 500 plate appearances, that amounts to about 1.5 fewer hits compared to otherwise.</li>
<li>When we select certain fixed effects, we find that the next batter’s xwOBA continue to have a small but significant impact on the current plate appearance’s xwOBA, and this effect is negative. A stronger on-deck hitter results in lower than expected outcomes for that plate appearance.</li>
</ol>
</section>
<section id="introduction-to-lineup-protection" class="level2">
<h2 class="anchored" data-anchor-id="introduction-to-lineup-protection">Introduction to Lineup Protection</h2>
<p>Batting order optimization is a heavily studied aspect of baseball decision-making, where teams construct lineups to maximize run production. Most studies in this area assume that hitters in the lineup are independent of one another. However, the concept of lineup protection—the idea that a hitter’s performance is influenced by the quality of the hitter after them—remains debated within the sabermetrics community, most often not believed in by it; it has not been supported by previous statistical studies. Although batting order decisions may offer only marginal advantages in expected runs, in an era where every competitive edge counts, even subtle effects like lineup protection deserve closer examination. The theory behind lineup protection is that a hitter with a good hitter behind them will be harder to pitch around because pitchers won’t want to face the guy after him either, particularly with more runners on base. Thus, walks would decrease, and that would mean more fastballs, strikes, and pitches over the plate, essentially increasing the probability for productive hitting, specifically extra-base hits (doubles, triples, and homeruns).</p>
<p>There are two main ways to study lineup protection:</p>
<p><strong>Pitcher-Centric Analysis:</strong> Examining how pitchers alter their approach based on the quality next hitter. Previous research using 30 hitter pairs since the advent of Statcast suggested that protected hitters see an average of 0.25% more strikes compared to league average, and 0.07% more pitches down the middle of the zone. This would lead to 6 additional strikes and 2 additional pitches down the middle over a season. This study was extremely limited, however, and did not account for situations without protection, only used 30 pairs of hitters, and only compared the strike percentage a protected hitter received to the league average of that year, not to the strike percentage they had in other non-protected plate appearances. If lineup protection were to exist, teams should avoid wasting lineup protection on free swingers (putting free swingers before “protectors”) so that the protection is not wasted on hitters who would swing at a higher rate anyway (The Paraball Notes, 2024). Quantitatively, the hitter who bats behind you SHOULD impact the pitches you see, because the run expectancy of certain plays occurring (like walks) would change based on who the following batter is (Weinberg, 2013). Evidence of certain pairs often seems to point to the opposite, with a 2012 evaluation of players hitting after Andrew McCutchen, Ryan Braun, and Joey Votto showing no evidence that pitchers were pitching them differently based on the protection they had (Cameron, 2012).</p>
<p>Hall of Famer Miguel Cabrera attributed part of his power struggles early in the 2019 season to a lack of lineup protection, essentially calling out productive-yet-not-spectacular hitter behind him, Niko Goodrum, saying, “In the past… I got a big bat behind me. You see the way guys pitch me? that explains everything.” His manager responded by saying his statement was “crazy.” Data revealed that he wasn’t getting particularly fewer fastballs, strikes, or good pitches to hit in general, and that in his particular case, there wasn’t evidence for lineup protection (Stavenhagen, 2019).</p>
<p><strong>Hitter Outcome Analysis:</strong> Investigating whether the quality of the next hitter influences the current hitter’s performance. Pre-Pitch F/X research found that pitchers who know that a good hitter is up next will “pitch around” the current hitter, resulting in significantly more walks, and moderately more strikeouts. However, it found that when it comes to putting the ball in play, there was no significant impact (Tango, 2006). Much of the sabermetric community says that lineup protection is a myth, and that a player’s production is almost solely determined by their own skills; luck and random variation also play a small role (Ambrosino, 2011). A 2008 study found that with a small magnitude, the quality of the on-deck hitter negatively impacts the preceding hitter (Bradbury, 2008).</p>
<p>However, a study in 2011 using Retrosheet play-by-play data from 2002-2009 MLB seasons found that power numbers did have significant differences in situations of potential lineup protection. This study argues that previous evidence of lineup protection was not uncovered because endogeneity bias introduced by managers selectively choosing their lineups. For a player’s own performance, they likely are hitting better than their own season averages when they are near the top of the lineup (they have more protection) because they are already doing well at that time for a number of reasons. A good hitter who, for whatever reason, is hitting poorly will be put at the bottom of the lineup (and have less protection), but likely hit well at that spot, and thus, we would observe better hitting with less protection. Thus, protection and performance numbers become tangled in unobservable ways. While these endogeneity issues are a concern, they seem to work in both directions, and with a robust enough dataset, we should be able to see the effects of lineup protection, if it is a real phenomenon.</p>
<p>Using injuries to a batter’s “protector” as a quasi-random natural experiment, this study finds that batters who have stronger protection (i.e., a higher OPS hitter behind them) produce significantly more power. Specifically, a 100-point increase in the protector’s OPS correlates with a 9.7% rise in extra-base hits, and the effect is especially pronounced for third hitters (a 26% increase). The results also suggest that when left unprotected, batters draw more walks—particularly intentional walks, as previous literature has supported (Phillips, 2011). It also found that hits in general remained unchanged with protection or not, suggesting that batters are not simply putting the ball into play fewer times, but having less powerful, and thus, productive, contact. However, this study simply made claims about the distribution of outcomes and not about overall offensive production. Protected hitters got fewer walks and more extra-base hits, which act in opposing manners. Our study will use Expected Weighted On-Base Average, an offensive statistic that correlates directly with a player’s overall contribution to run production from the plate, to tackle this gap in research.</p>
<p>We will also use a large sample size of over 3 million plate appearances from 2015-2024 to ensure that our results are robust.</p>
<p>Most other previous literature of hitter outcome analysis has been rather anecdotal, focusing on specific players and how they fare with protection. Using over 3000 Plate Appearances from Pete Alonso’s career before his 2024 season, we can see higher slugging percentages with better hitters behind him, along with being 11% more likely to homer. With worse protection, he is more likely to walk, although his strikeout rates go against previous research and actually decrease with poor hitters behind him (Britton, 2024). Other research takes specific teams and analyzes whether the topic of lineup protection even applies and whether it serves a purpose in that roster’s decision-making. When the Diamondbacks acquired Mark Trumbo in 2014, writers brought up the fact that even though Trumbo’s power threat could serve to protect Paul Goldschmidt, Trumbo may not even be much better than other Diamondbacks hitters who could replace him in terms of offensive threat in general (Wiser, 2014). In 2015, Billy Hamilton pointed to a different sort of offensive advantage owing to the hitter behind him–knowing Joey Votto was hitting after him, an incredibly selective hitter often with long counts, allowed Hamilton to be patient and wait for the right pitch to steal on. In this situation, with a small sample size, the threat of Votto was preventing opposing pitchers from throwing fastballs with Hamilton on base, allowing Hamilton to get better base-stealing opportunities (Petriello, 2015).</p>
<p>It is worth noting that many within baseball discuss lineup protection with certainty. Alonso had pushed for J.D. Martinez to join and hit behind him for the Mets in 2024, hoping it would help his offensive statistics. Interviews with several within the game in 2015 resulted in a plethora of answers, from Joe Girardi saying lineup protection was most significant in lefty-righty matchups, Madison Bumgarner saying he doesn’t pay attention to the on-deck circle, Tim Hudson saying that it’s “foolish if you don’t look at the next hitter,” and multiple other pitchers saying it is a factor in their decision-making, especially later in the game (Laurila, 2016).</p>
<p>It is also worth noting that these anecdotal examinations are subject to sample size constraints and extremely limited in their ability to observe lineup protection on a large scale in Major League Baseball. This article aims to tackle that problem.</p>
</section>
<section id="aim" class="level2">
<h2 class="anchored" data-anchor-id="aim">Aim</h2>
<p>This article aims to provide further insights into lineup protection using pitch-by-pitch data Statcast data from the 2015 to 2024 Major League Baseball seasons, focusing on analyzing hitter outcomes. While literature is mixed and often negative on the existence of lineup protection, it often uses anecdotal evidence, and a more thorough investigation is necessary, especially one using the more advanced expected statistics we now have available.</p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>We would like our independent variables to be the following:</p>
<ul>
<li><p>Current pitcher random effects</p></li>
<li><p>Current hitter’s handedness and underlying quality (e.g.&nbsp;xwOBA, xBA)</p></li>
<li><p>Next hitter’s handedness and underlying quality (e.g.&nbsp;xwOBA, xBA)</p></li>
<li><p>Base-out state</p></li>
<li><p>Inning</p></li>
<li><p>Run differential</p></li>
</ul>
<p>Previous studies have looked at protection as a binary independent variable, but that is a narrow view on lineup protection. Lineup protection must be considered as a continuous variable because some players will protect more than others.</p>
<p>Our outcome variable for our first model will be that plate appearance’s xwOBA, which will essentially give us the quality of that plate appearance based on the independent variables. We would then like to see what factor the quality of the next batter has in the outcome.</p>
<p>We will use a mixed-effects linear model to account for the random effects of pitchers and batters. Our models are described in detail below.</p>
</section>
<section id="methods" class="level2">
<h2 class="anchored" data-anchor-id="methods">Methods</h2>
<p>For full methods and model outputs <a href="../../appendix/blog1-appendix.html">view the full appendix here</a>.</p>
</section>
<section id="model-1-mixed-effects-linear-model-of-plate-appearances" class="level2">
<h2 class="anchored" data-anchor-id="model-1-mixed-effects-linear-model-of-plate-appearances">Model #1: Mixed Effects Linear Model of Plate Appearances</h2>
<section id="i.-overall-offensive-value-woba-and-xwoba" class="level3">
<h3 class="anchored" data-anchor-id="i.-overall-offensive-value-woba-and-xwoba">I. Overall Offensive Value: wOBA and xWOBA</h3>
<p>First, let’s look at residuals from season-long averages for each plate appearance. We will read in our libraries and data.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lmerTest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'lmerTest'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:lme4':

    lmer</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stats':

    step</code></pre>
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ ggplot2   3.5.1     ✔ tibble    3.2.1
✔ lubridate 1.9.4     ✔ tidyr     1.3.1
✔ purrr     1.0.4     </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ tidyr::expand() masks Matrix::expand()
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
✖ tidyr::pack()   masks Matrix::pack()
✖ tidyr::unpack() masks Matrix::unpack()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pubtheme)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: plotly

Attaching package: 'plotly'

The following object is masked from 'package:ggplot2':

    last_plot

The following object is masked from 'package:stats':

    filter

The following object is masked from 'package:graphics':

    layout

Loading required package: scales

Attaching package: 'scales'

The following object is masked from 'package:purrr':

    discard

The following object is masked from 'package:readr':

    col_factor

Loading required package: ggrepel</code></pre>
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>pa_data_final <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="st">"data/pa_data_final.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Our first model will be a mixed-effects linear model of plate appearances, where we will use the xwOBA of the current plate appearance as our outcome variable. We will use the xwOBA of the current and next batters as our main independent fixed effect, and we will also include the batter’s handedness matchup, the next batter’s handedness matchup, the baserunner state, outs when up, run differential, and game year as fixed effects. We will also include random effects for pitcher and batter. Note that the next batter’s handedness matchup is the handedness of the next batter with the handedness of the current pitcher, and thus does not account for potential anticipated calls to the bullpen (when a pitcher knows they are coming out after the current batter) or pinch-hitting situations.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>m_protection_1 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  pa_xwOBA <span class="sc">~</span> batter_xwOBA <span class="sc">+</span> next_batter_xwOBA <span class="sc">+</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    current_matchup_advantage <span class="sc">+</span> next_matchup_advantage <span class="sc">+</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    baserunner_state <span class="sc">+</span> outs_when_up <span class="sc">+</span> run_diff <span class="sc">+</span> game_year <span class="sc">+</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">|</span> pitcher),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pa_data_final</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_protection_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: 
pa_xwOBA ~ batter_xwOBA + next_batter_xwOBA + current_matchup_advantage +  
    next_matchup_advantage + baserunner_state + outs_when_up +  
    run_diff + game_year + (1 | pitcher)
   Data: pa_data_final

REML criterion at convergence: 741757.7

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.3711 -0.7738 -0.3856  0.7186  4.7365 

Random effects:
 Groups   Name        Variance  Std.Dev.
 pitcher  (Intercept) 0.0005167 0.02273 
 Residual             0.1460217 0.38213 
Number of obs: 809909, groups:  pitcher, 2358

Fixed effects:
                            Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)               -6.786e-05  4.986e-03  4.402e+05  -0.014 0.989140    
batter_xwOBA               1.020e+00  1.128e-02  8.098e+05  90.401  &lt; 2e-16 ***
next_batter_xwOBA         -2.742e-02  1.170e-02  8.097e+05  -2.344 0.019074 *  
current_matchup_advantage  2.001e-02  9.017e-04  5.310e+05  22.191  &lt; 2e-16 ***
next_matchup_advantage     8.058e-04  9.045e-04  4.962e+05   0.891 0.372992    
baserunner_state1B         1.595e-03  1.147e-03  8.097e+05   1.390 0.164438    
baserunner_state1B-2B      1.960e-03  1.781e-03  8.098e+05   1.100 0.271155    
baserunner_state1B-3B      6.192e-03  2.639e-03  8.098e+05   2.346 0.018970 *  
baserunner_state2B         7.951e-03  1.612e-03  8.098e+05   4.933 8.10e-07 ***
baserunner_state2B-3B      3.182e-03  3.054e-03  8.098e+05   1.042 0.297390    
baserunner_state3B         4.995e-03  2.690e-03  8.097e+05   1.857 0.063292 .  
baserunner_stateLoaded     1.820e-03  2.937e-03  8.092e+05   0.620 0.535527    
outs_when_up              -4.443e-03  5.360e-04  8.096e+05  -8.288  &lt; 2e-16 ***
run_diff                   6.541e-04  1.435e-04  5.644e+05   4.559 5.15e-06 ***
game_year2016              2.664e-03  1.800e-03  3.502e+05   1.480 0.138963    
game_year2017              3.513e-03  1.872e-03  2.067e+05   1.877 0.060501 .  
game_year2018              3.275e-03  1.904e-03  1.401e+05   1.721 0.085344 .  
game_year2019              7.899e-03  1.996e-03  1.154e+05   3.958 7.57e-05 ***
game_year2020              2.297e-03  3.233e-03  3.128e+05   0.710 0.477489    
game_year2021              6.133e-03  2.001e-03  6.650e+04   3.064 0.002183 ** 
game_year2022              6.765e-03  2.009e-03  5.118e+04   3.367 0.000760 ***
game_year2023              7.512e-03  1.994e-03  3.849e+04   3.768 0.000165 ***
game_year2024              6.872e-03  2.039e-03  3.030e+04   3.371 0.000751 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Correlation matrix not shown by default, as p = 23 &gt; 12.
Use print(x, correlation=TRUE)  or
    vcov(x)        if you need it</code></pre>
</div>
</div>
<p>One piece of verifying evidence for our model is that the coefficient of <code>batter_xwOBA</code> is about 1 (it is 1.02), as we are predicting the xwOBA of a player’s plate appearance using their average xwOBA from the year. It is also verifying that our <code>current_matchup_advantage</code> is positive and signficant, with a coefficient of 0.02, indicating that the batter’s handedness matchup advantage does have a positive impact on the xwOBA of the current plate appearance.</p>
<p>When accounting for all of the other variables, we can see that the coefficient of <code>next_batter_xwOBA</code> is negative, at -0.02742, and signficant at the <span class="math inline">\(\alpha\)</span> = 0.05 level, with a p-value of 0.02.</p>
<p>This coefficient means that with a 0.100 increase in the next batter’s xwOBA, we would expect a 0.0027 decrease in the current plate appearance’s xwOBA. This is a small effect, but it is statistically significant and suggests that a reverse lineup protection, or a lineup penalty does exist to some degree when a better hitter is on deck.</p>
<p>We do not find that a matchup advantage on deck has a significant impact on the current plate appearance’s xwOBA, with a coefficient of 0.0008 and a p-value of 0.37.</p>
<p>While we will want to use model selection techniques to check if all of these variables are important, other signficant coefficients make sense. The only two <code>baserunner_state</code> with a singificant coefficient is when a runner is on 2B, with a positive coefficient of 0.008, or 1B and 3B, with a postivie coefficient of 0.006 indicating that having a runner on 2B or 1B-3B increases the xwOBA of the current plate appearance. The <code>outs_when_up</code> variable has a negative and signficiant coefficient, indicating that having more outs when up decreases the xwOBA of the current plate appearance. The <code>run_diff</code> variable has a positive and significant coefficient, indicating that having a larger run differential increases the xwOBA of the current plate appearance. This could indicate that when teams are up by a lot, they tend to be facing weaker pitchers, or have a confidence that helps them at the plate. Overall, this effect is incredibly small. <code>game_year</code> also makes sense, as the most signficant positive coefficeints in years 2019, 2021, 2022, 2023, and 2024 were all years with higher run scoring environments than the reference level of 2015.</p>
<p>Let’s check this model with a mixed-effects linear model of plate appearances, where we will use the xwOBA difference of the current plate appearance from the batter’s season long average as the outcome variable. We will use the xwOBA of the next batter as our main independent variable, and we will also include the batter’s handedness, the next batter’s handedness, the baserunner state, outs when up, run differential, and game year as fixed effects. We will also include random effects for pitcher.</p>
<p>It is worth noting that initially we got a singularity with regards to the random effect <code>(1 | batter)</code> when it was included. This indicated that the model already had the effect of the batter baked into the model through the <code>xwOBA_diff</code> outcome variable, which is derived from <code>pa_xwOBA</code> and <code>batter_xwOBA</code>. So, we knew that almost all of the variance between batters can be accounted for by their season-long <code>batter_xwOBA</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>m_protection_2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  xwOBA_diff <span class="sc">~</span> next_batter_xwOBA <span class="sc">+</span> </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    current_matchup_advantage <span class="sc">+</span> next_matchup_advantage <span class="sc">+</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    baserunner_state <span class="sc">+</span> outs_when_up <span class="sc">+</span> run_diff <span class="sc">+</span> game_year <span class="sc">+</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">|</span> pitcher),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pa_data_final</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_protection_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: xwOBA_diff ~ next_batter_xwOBA + current_matchup_advantage +  
    next_matchup_advantage + baserunner_state + outs_when_up +  
    run_diff + game_year + (1 | pitcher)
   Data: pa_data_final

REML criterion at convergence: 741753.7

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.3634 -0.7742 -0.3862  0.7195  4.7311 

Random effects:
 Groups   Name        Variance  Std.Dev.
 pitcher  (Intercept) 0.0005166 0.02273 
 Residual             0.1460221 0.38213 
Number of obs: 809909, groups:  pitcher, 2358

Fixed effects:
                            Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)                4.685e-03  4.192e-03  3.107e+05   1.118 0.263711    
next_batter_xwOBA         -2.224e-02  1.132e-02  8.099e+05  -1.964 0.049480 *  
current_matchup_advantage  1.995e-02  9.010e-04  5.317e+05  22.139  &lt; 2e-16 ***
next_matchup_advantage     7.917e-04  9.044e-04  4.965e+05   0.875 0.381370    
baserunner_state1B         1.633e-03  1.147e-03  8.097e+05   1.423 0.154655    
baserunner_state1B-2B      1.990e-03  1.781e-03  8.098e+05   1.117 0.263913    
baserunner_state1B-3B      6.218e-03  2.639e-03  8.098e+05   2.356 0.018474 *  
baserunner_state2B         7.969e-03  1.612e-03  8.098e+05   4.944 7.65e-07 ***
baserunner_state2B-3B      3.147e-03  3.054e-03  8.098e+05   1.031 0.302774    
baserunner_state3B         5.007e-03  2.690e-03  8.097e+05   1.862 0.062659 .  
baserunner_stateLoaded     1.806e-03  2.937e-03  8.092e+05   0.615 0.538656    
outs_when_up              -4.439e-03  5.360e-04  8.096e+05  -8.281  &lt; 2e-16 ***
run_diff                   6.577e-04  1.435e-04  5.646e+05   4.584 4.56e-06 ***
game_year2016              2.747e-03  1.800e-03  3.498e+05   1.526 0.126944    
game_year2017              3.649e-03  1.870e-03  2.062e+05   1.951 0.051045 .  
game_year2018              3.350e-03  1.903e-03  1.399e+05   1.761 0.078324 .  
game_year2019              8.099e-03  1.992e-03  1.147e+05   4.065 4.81e-05 ***
game_year2020              2.576e-03  3.229e-03  3.116e+05   0.798 0.425082    
game_year2021              6.297e-03  1.999e-03  6.616e+04   3.150 0.001636 ** 
game_year2022              6.727e-03  2.009e-03  5.118e+04   3.348 0.000814 ***
game_year2023              7.618e-03  1.993e-03  3.839e+04   3.823 0.000132 ***
game_year2024              6.869e-03  2.039e-03  3.030e+04   3.369 0.000755 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Correlation matrix not shown by default, as p = 22 &gt; 12.
Use print(x, correlation=TRUE)  or
    vcov(x)        if you need it</code></pre>
</div>
</div>
<p>Coefficients of this model mirror those of the previous model in both signficance and direction, but our <code>next_batter_xwOBA</code> coefficient has decreased in magnitude to -0.02224, and is still signficant at the <span class="math inline">\(\alpha\)</span> = 0.05 level, with a p-value of 0.05. This further supports our evidence that the next batter’s xwOBA does have a small but significant impact on the current plate appearance’s xwOBA, and that this effect is negative.</p>
<p>For interpretability, we will go back to predicting <code>pa_xwOBA</code> in our next model, as it is a more intuitive metric to understand than the difference from the batter’s season-long average.</p>
<p><strong>Takeaway:</strong> The next batter’s xwOBA does have a small but significant impact on the current plate appearance’s xwOBA, and this effect is negative. A stronger on-deck hitter results in lower than expected outcomes for that plate appearance.</p>
<p>If we now want to incorporate how different hitters and pitchers are affected by the next batter, we can add a slope for the next batter’s xwOBA as a random effect. This will allow us to see how the effect of the next batter’s xwOBA varies by pitcher. We do not expect an equivalent effect with batters, as players describe how the pitcher will act differently based on the abilities of the next batter, not the batter. To make sure there is enough data to get a good estimate of the slope, we will only include pitchers with at least 100 plate appearances in our dataset for a given year. We will treat the slope and intercept independently, as we do not expect that pitchers who allow higher/lower overall xwOBA also respond differently to lineup protection.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count number of plate appearances per pitcher per year</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>pitcher_counts <span class="ot">&lt;-</span> pa_data_final <span class="sc">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(pitcher, game_year) <span class="sc">%&gt;%</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">n_pa =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(n_pa <span class="sc">&gt;=</span> <span class="dv">100</span>) </span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter dataset to just those pitchers</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>pa_filtered <span class="ot">&lt;-</span> pa_data_final <span class="sc">%&gt;%</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pitcher_year =</span> <span class="fu">interaction</span>(pitcher, game_year)) <span class="sc">%&gt;%</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pitcher_year <span class="sc">%in%</span> <span class="fu">interaction</span>(pitcher_counts<span class="sc">$</span>pitcher, pitcher_counts<span class="sc">$</span>game_year))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s run our model using <code>pa_filtered</code>.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>m_protection_slope <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  pa_xwOBA <span class="sc">~</span> batter_xwOBA <span class="sc">+</span> next_batter_xwOBA <span class="sc">+</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    current_matchup_advantage <span class="sc">+</span> next_matchup_advantage <span class="sc">+</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    baserunner_state <span class="sc">+</span> outs_when_up <span class="sc">+</span> run_diff <span class="sc">+</span> game_year <span class="sc">+</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">+</span> next_batter_xwOBA <span class="sc">||</span> pitcher_year),  <span class="co"># uncorrelated random effects</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pa_filtered</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_protection_slope)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: 
pa_xwOBA ~ batter_xwOBA + next_batter_xwOBA + current_matchup_advantage +  
    next_matchup_advantage + baserunner_state + outs_when_up +  
    run_diff + game_year + (1 + next_batter_xwOBA || pitcher_year)
   Data: pa_filtered

REML criterion at convergence: 565997.2

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.3677 -0.7696 -0.3876  0.7057  4.7346 

Random effects:
 Groups         Name              Variance  Std.Dev.
 pitcher_year   (Intercept)       0.0003614 0.01901 
 pitcher_year.1 next_batter_xwOBA 0.0028632 0.05351 
 Residual                         0.1449113 0.38067 
Number of obs: 622199, groups:  pitcher_year, 2876

Fixed effects:
                            Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)               -4.600e-04  5.783e-03  6.510e+04  -0.080 0.936606    
batter_xwOBA               1.017e+00  1.283e-02  6.222e+05  79.288  &lt; 2e-16 ***
next_batter_xwOBA         -3.152e-02  1.336e-02  1.258e+05  -2.359 0.018346 *  
current_matchup_advantage  1.944e-02  1.018e-03  3.706e+05  19.093  &lt; 2e-16 ***
next_matchup_advantage     8.983e-04  1.019e-03  3.322e+05   0.881 0.378098    
baserunner_state1B         1.537e-03  1.304e-03  6.220e+05   1.179 0.238511    
baserunner_state1B-2B      9.683e-04  2.078e-03  6.222e+05   0.466 0.641151    
baserunner_state1B-3B      2.719e-03  3.080e-03  6.220e+05   0.883 0.377282    
baserunner_state2B         6.106e-03  1.843e-03  6.221e+05   3.314 0.000921 ***
baserunner_state2B-3B     -1.422e-03  3.559e-03  6.220e+05  -0.399 0.689560    
baserunner_state3B         7.113e-03  3.085e-03  6.220e+05   2.305 0.021151 *  
baserunner_stateLoaded    -2.722e-03  3.593e-03  6.219e+05  -0.758 0.448645    
outs_when_up              -4.318e-03  6.092e-04  6.217e+05  -7.087 1.37e-12 ***
run_diff                   1.121e-04  1.837e-04  4.468e+05   0.610 0.541649    
game_year2016              9.108e-04  2.866e-03  2.200e+03   0.318 0.750657    
game_year2017             -1.016e-04  2.911e-03  2.327e+03  -0.035 0.972148    
game_year2018             -1.458e-03  2.931e-03  2.290e+03  -0.497 0.618886    
game_year2019              2.813e-03  3.100e-03  2.453e+03   0.907 0.364376    
game_year2020             -1.089e-02  1.486e-02  4.693e+03  -0.733 0.463727    
game_year2021              1.866e-03  3.026e-03  2.450e+03   0.617 0.537514    
game_year2022              1.698e-03  2.977e-03  2.303e+03   0.570 0.568543    
game_year2023              1.003e-03  2.887e-03  2.376e+03   0.348 0.728162    
game_year2024             -1.737e-03  2.937e-03  2.286e+03  -0.591 0.554288    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Correlation matrix not shown by default, as p = 23 &gt; 12.
Use print(x, correlation=TRUE)  or
    vcov(x)        if you need it</code></pre>
</div>
</div>
<p>While the signficance of <code>game_year</code> coefficients have disappeared, the rest of the coefficients are similar to the previous model. The coefficient of <code>next_batter_xwOBA</code> is now -0.0315, and is signficant at the <span class="math inline">\(\alpha\)</span> = 0.05 level, with a p-value of 0.02.</p>
<section id="ia.-inspection-of-the-random-effects-for-xwoba" class="level4">
<h4 class="anchored" data-anchor-id="ia.-inspection-of-the-random-effects-for-xwoba">IA. Inspection of the Random Effects for xwOBA</h4>
<p>In order to get an indication of whether these random slopes are important and not just a product of random noise, we can look at the random effects of the model. We can do this by looking at the random slopes for the next batter’s xwOBA for each pitcher-year combination.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Convert to a dataframe with rownames as a column</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>re_df <span class="ot">&lt;-</span> <span class="fu">ranef</span>(m_protection_slope)<span class="sc">$</span>pitcher_year <span class="sc">%&gt;%</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="at">var =</span> <span class="st">"pitcher_year"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Separate into pitcher ID and year</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>re_df <span class="ot">&lt;-</span> re_df <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(pitcher_year, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"pitcher"</span>, <span class="st">"year"</span>), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">."</span>, <span class="at">convert =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Initialize a list to store correlation results</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>yoy_results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Loop through each year pair and calculate correlations</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(re_df<span class="sc">$</span>year))</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(years) <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  y1 <span class="ot">&lt;-</span> years[i]</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  y2 <span class="ot">&lt;-</span> years[i <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>  df_pair <span class="ot">&lt;-</span> re_df <span class="sc">%&gt;%</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="fu">c</span>(y1, y2)) <span class="sc">%&gt;%</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(pitcher, year, next_batter_xwOBA) <span class="sc">%&gt;%</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> year, <span class="at">values_from =</span> next_batter_xwOBA, <span class="at">names_prefix =</span> <span class="st">"xwOBA_"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>()</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  cor_val <span class="ot">&lt;-</span> <span class="fu">cor</span>(df_pair[[<span class="fu">paste0</span>(<span class="st">"xwOBA_"</span>, y1)]], df_pair[[<span class="fu">paste0</span>(<span class="st">"xwOBA_"</span>, y2)]])</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  yoy_results[[<span class="fu">paste0</span>(y1, <span class="st">"_to_"</span>, y2)]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">from =</span> y1,</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">to =</span> y2,</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">correlation =</span> cor_val,</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_shared_pitchers =</span> <span class="fu">nrow</span>(df_pair)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="do">## Print all year-over-year correlations</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>yoy_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(yoy_results, <span class="at">.id =</span> <span class="st">"year_pair"</span>)</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(yoy_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 5
  year_pair     from    to correlation n_shared_pitchers
  &lt;chr&gt;        &lt;int&gt; &lt;int&gt;       &lt;dbl&gt;             &lt;int&gt;
1 2015_to_2016  2015  2016       0.396               221
2 2016_to_2017  2016  2017       0.374               220
3 2017_to_2018  2017  2018       0.367               200
4 2018_to_2019  2018  2019       0.377               185
5 2019_to_2020  2019  2020       0.175                 9
6 2020_to_2021  2020  2021       0.571                 9
7 2021_to_2022  2021  2022       0.317               182
8 2022_to_2023  2022  2023       0.328               191
9 2023_to_2024  2023  2024       0.261               199</code></pre>
</div>
</div>
<p>All of these Year-Over-Year correlations (with 2020 results ommitted due to limited sample size) are positive and greater than 0.3, except for 2019 to 2021 (still 0.25). This indicates that the random slopes for the next batter’s xwOBA are relatively stable over time, and that pitchers who are more affected by the next batter’s xwOBA in one year are likely to be similarly affected in the following year. This implies that the effect of the next batter’s xwOBA is not just a product of random noise, but rather a consistent pattern across pitchers.</p>
<p>We can graph the most recent year pair (2023 to 2024) to visualize the relationship between the random slopes for the next batter’s xwOBA in those two years.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Make a graph for the most recent year pair (2023 to 2024)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>re_23_24 <span class="ot">&lt;-</span> re_df <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">2023</span>, <span class="dv">2024</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pitcher, year, next_batter_xwOBA) <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> year, <span class="at">values_from =</span> next_batter_xwOBA, <span class="at">names_prefix =</span> <span class="st">"xwOBA_"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Plot</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(re_23_24, <span class="fu">aes</span>(<span class="at">x =</span> xwOBA_2023, <span class="at">y =</span> xwOBA_2024)) <span class="sc">+</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="at">color =</span> <span class="st">"blue"</span>) <span class="sc">+</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">slope =</span> <span class="dv">1</span>, <span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Pitcher Susceptibility to Lineup Protection (2023 vs. 2024)"</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste0</span>(<span class="st">"r = "</span>, <span class="fu">round</span>(<span class="fu">cor</span>(re_23_24<span class="sc">$</span>xwOBA_2023, re_23_24<span class="sc">$</span>xwOBA_2024), <span class="dv">3</span>)),</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Random Slope on next_batter_xwOBA (2023)"</span>,</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Random Slope on next_batter_xwOBA (2024)"</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_pub</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Now that we know that these random slopes are stable over time, we will decide to keep them in our model going forward for interpretability.</p>
<p>This also means that studying indvidual pitcher’s susceptibility to lineup protection is a worthwhile endeavor. We can look at the top 10 and bottom 10 pitchers in terms of their random slope for the next batter’s xwOBA.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Get 2024 slopes</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>slopes_2024 <span class="ot">&lt;-</span> re_df <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2024</span>) <span class="sc">%&gt;%</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(pitcher, year, next_batter_xwOBA)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Get top and bottom 10</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>top_10 <span class="ot">&lt;-</span> slopes_2024 <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(<span class="fu">desc</span>(next_batter_xwOBA)) <span class="sc">%&gt;%</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>bottom_10 <span class="ot">&lt;-</span> slopes_2024 <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(next_batter_xwOBA) <span class="sc">%&gt;%</span> <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Base URL of the data</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>base_url <span class="ot">&lt;-</span> <span class="st">"https://raw.githubusercontent.com/chadwickbureau/register/master/data/"</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Create vector of suffixes for filenames</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>suffixes <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>, letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>file_urls <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"people-"</span>, suffixes, <span class="st">".csv"</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Read and combine all files safely, treating all columns as characters</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>people <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(file_urls, <span class="sc">~</span> <span class="fu">read_csv</span>(.x, <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">.default =</span> <span class="st">"c"</span>)))</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Clean and convert MLBAM ID for joining</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>people_clean <span class="ot">&lt;-</span> people <span class="sc">%&gt;%</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(key_mlbam, name_first, name_last) <span class="sc">%&gt;%</span></span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">key_mlbam =</span> <span class="fu">as.integer</span>(key_mlbam))</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="do">## Join to top 10 and bottom 10 results</span></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>top_10 <span class="ot">&lt;-</span> top_10 <span class="sc">%&gt;%</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(people_clean, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"pitcher"</span> <span class="ot">=</span> <span class="st">"key_mlbam"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name_first, name_last, pitcher, next_batter_xwOBA)</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>bottom_10 <span class="ot">&lt;-</span> bottom_10 <span class="sc">%&gt;%</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(people_clean, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"pitcher"</span> <span class="ot">=</span> <span class="st">"key_mlbam"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(name_first, name_last, pitcher, next_batter_xwOBA)</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a><span class="do">## Display</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>top_10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   name_first name_last pitcher next_batter_xwOBA
1     Roddery     Muñoz  682610        0.07649964
2      Martín     Pérez  527048        0.06512998
3     Taijuan    Walker  592836        0.06485610
4       Randy   Vásquez  681190        0.05401922
5     Emerson   Hancock  676106        0.04734642
6         Jon      Gray  592351        0.04470282
7     Valente   Bellozo  678368        0.04205315
8     Anthony    Molina  683627        0.04131252
9       Kenta     Maeda  628317        0.04045721
10       Kyle    Gibson  502043        0.03925565</code></pre>
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>bottom_10</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   name_first name_last pitcher next_batter_xwOBA
1       Tyler   Glasnow  607192       -0.06585163
2       Mason    Miller  695243       -0.06031694
3        Paul    Skenes  694973       -0.05088475
4      Raisel  Iglesias  628452       -0.04973264
5       Bryan       Woo  693433       -0.04841714
6      Justin    Steele  657006       -0.04629680
7         Joe   Jiménez  641729       -0.04529517
8        Ryan    Walker  676254       -0.04428940
9        Sean    Hjelle  663546       -0.04105592
10     Carlos     Rodón  607074       -0.04101263</code></pre>
</div>
</div>
<p>In 2024, the random slopes on next_batter_xwOBA reveal how individual pitchers deviated from the average lineup protection effect—where the fixed effect of next_batter_xwOBA was negative, indicating that pitchers tend to allow lower expected outcomes when a strong hitter is looming. At the top of the slope distribution, pitchers like Roddery Muñoz, Martín Pérez, and Randy Vásquez had positive random slopes, meaning the usual lineup protection suppression effect was less true for them—or even reversed. These pitchers were more susceptible to lineup protection (they allow better results when a stronger batter is on deck).</p>
<p>In contrast, pitchers like Tyler Glasnow, Paul Skenes, and Bryan Woo had even more negative slopes than average, suggesting they are especially effective at suppressing outcomes when a strong next batter is present. These pitchers were less affected (or may even pitch better) in those scenarios where a stronger batter is on deck.</p>
<p>It is worth noting that although some of the league’s best pitchers (like Glasnow and Skenes) are at the bottom of this list, this does not mean that these lists are simply a ranking of pitcher quality. The random slopes are not correlated with the fixed effect of next_batter_xwOBA, and thus, a pitcher can be very good and still have a high random slope. This is because the random slope is measuring how much the pitcher deviates from the average lineup protection effect, not how good they are overall.</p>
<p>So, when we see some of the leagues best pitchers at the bottom of this list, it means that one of their skills is to be able to pitch well regardless of the next batter’s quality, and potentially even better when there is a threat looming.</p>
<p><strong>Takeaway:</strong> Some of the league’s best pitchers perform better when a strong hitter is on deck, serving as an indication of mental aptitude or ability to elevate in high-leverage moments that makes them so successful. This suggests that lineup protection may not be a universal phenomenon and that individual pitchers may have different responses to it.</p>
</section>
<section id="ib.-drivers-of-the-overall-offensive-effect" class="level4">
<h4 class="anchored" data-anchor-id="ib.-drivers-of-the-overall-offensive-effect">IB. Drivers of the Overall Offensive Effect</h4>
<p>Let’s try to uncover where these overall offensive effects are coming from. Since <code>is_walk</code>, <code>is_strikeout</code>, and <code>is_extra_base_hit</code> are binary outcome variables (TRUE/FALSE), we’ll want to use logistic regression models. We will use <code>glm</code> instead of <code>glmer</code> as models including failed to converge within a reasonable amount of time. First, we will look at walks.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>m_protection_walk <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  is_walk <span class="sc">~</span> batter_bb_pct <span class="sc">+</span> next_batter_xwOBA <span class="sc">+</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    current_matchup_advantage <span class="sc">+</span> next_matchup_advantage <span class="sc">+</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    baserunner_state <span class="sc">+</span> outs_when_up <span class="sc">+</span> run_diff <span class="sc">+</span> game_year,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pa_data_final,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_protection_walk)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = is_walk ~ batter_bb_pct + next_batter_xwOBA + current_matchup_advantage + 
    next_matchup_advantage + baserunner_state + outs_when_up + 
    run_diff + game_year, family = binomial(link = "logit"), 
    data = pa_data_final)

Coefficients:
                           Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)               -3.604417   0.051621 -69.824  &lt; 2e-16 ***
batter_bb_pct             10.764657   0.147696  72.884  &lt; 2e-16 ***
next_batter_xwOBA         -0.180966   0.138735  -1.304  0.19210    
current_matchup_advantage  0.150153   0.010445  14.376  &lt; 2e-16 ***
next_matchup_advantage    -0.031530   0.010364  -3.042  0.00235 ** 
baserunner_state1B        -0.106451   0.014102  -7.549 4.39e-14 ***
baserunner_state1B-2B     -0.011978   0.021270  -0.563  0.57332    
baserunner_state1B-3B     -0.140937   0.033013  -4.269 1.96e-05 ***
baserunner_state2B         0.398295   0.016610  23.979  &lt; 2e-16 ***
baserunner_state2B-3B      0.470568   0.030704  15.326  &lt; 2e-16 ***
baserunner_state3B         0.354781   0.027459  12.920  &lt; 2e-16 ***
baserunner_stateLoaded    -0.241287   0.038858  -6.209 5.32e-10 ***
outs_when_up               0.089101   0.006316  14.106  &lt; 2e-16 ***
run_diff                   0.010447   0.001696   6.160 7.29e-10 ***
game_year2016              0.062527   0.020564   3.041  0.00236 ** 
game_year2017             -0.030562   0.021438  -1.426  0.15399    
game_year2018             -0.016728   0.021364  -0.783  0.43362    
game_year2019              0.014724   0.022190   0.664  0.50697    
game_year2020              0.006981   0.032404   0.215  0.82942    
game_year2021              0.016040   0.021642   0.741  0.45860    
game_year2022              0.032436   0.021892   1.482  0.13844    
game_year2023              0.016310   0.021369   0.763  0.44532    
game_year2024             -0.006361   0.022114  -0.288  0.77362    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 300566  on 509603  degrees of freedom
Residual deviance: 293300  on 509581  degrees of freedom
  (309808 observations deleted due to missingness)
AIC: 293346

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>As expected, <code>batter_bb_pct</code> and <code>current_matchup_advantage</code> both have positive and signficant coefficients in our walk model. <code>m_protection_walk</code> shows that the coefficient of <code>next_batter_xwOBA</code> is negative, but insignificant. This indicates that the next batter’s xwOBA does not have a significant impact on the current plate appearance’s walk rate. We can do the same for strikeouts:</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>m_protection_strikeout <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  is_strikeout <span class="sc">~</span> batter_k_pct <span class="sc">+</span> next_batter_xwOBA <span class="sc">+</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    current_matchup_advantage <span class="sc">+</span> next_matchup_advantage <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    baserunner_state <span class="sc">+</span> outs_when_up <span class="sc">+</span> run_diff <span class="sc">+</span> game_year,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pa_data_final,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>)</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_protection_strikeout)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = is_strikeout ~ batter_k_pct + next_batter_xwOBA + 
    current_matchup_advantage + next_matchup_advantage + baserunner_state + 
    outs_when_up + run_diff + game_year, family = binomial(link = "logit"), 
    data = pa_data_final)

Coefficients:
                            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)               -2.7599069  0.0404130 -68.293  &lt; 2e-16 ***
batter_k_pct               6.2888199  0.0688935  91.283  &lt; 2e-16 ***
next_batter_xwOBA          0.1196696  0.0993374   1.205    0.228    
current_matchup_advantage -0.0688817  0.0073531  -9.368  &lt; 2e-16 ***
next_matchup_advantage    -0.0026393  0.0073570  -0.359    0.720    
baserunner_state1B        -0.1499402  0.0097384 -15.397  &lt; 2e-16 ***
baserunner_state1B-2B     -0.1076912  0.0150464  -7.157 8.23e-13 ***
baserunner_state1B-3B     -0.2957063  0.0235681 -12.547  &lt; 2e-16 ***
baserunner_state2B        -0.0984864  0.0134549  -7.320 2.48e-13 ***
baserunner_state2B-3B     -0.1337799  0.0261563  -5.115 3.14e-07 ***
baserunner_state3B        -0.1344568  0.0226108  -5.947 2.74e-09 ***
baserunner_stateLoaded    -0.1370497  0.0254082  -5.394 6.89e-08 ***
outs_when_up               0.0605834  0.0044796  13.524  &lt; 2e-16 ***
run_diff                  -0.0137829  0.0012004 -11.482  &lt; 2e-16 ***
game_year2016             -0.0039130  0.0148857  -0.263    0.793    
game_year2017              0.0181779  0.0152747   1.190    0.234    
game_year2018              0.0179369  0.0152552   1.176    0.240    
game_year2019              0.0002611  0.0159714   0.016    0.987    
game_year2020              0.0149747  0.0236182   0.634    0.526    
game_year2021              0.0241461  0.0154535   1.563    0.118    
game_year2022              0.0124838  0.0155830   0.801    0.423    
game_year2023              0.0140535  0.0152468   0.922    0.357    
game_year2024              0.0224673  0.0154996   1.450    0.147    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 504132  on 509603  degrees of freedom
Residual deviance: 494273  on 509581  degrees of freedom
  (309808 observations deleted due to missingness)
AIC: 494319

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
<p>The coefficient of <code>next_batter_xwOBA</code> is positive, but insignificant again. This indicates that the next batter’s xwOBA does not have a significant impact on the current plate appearance’s strikeout rate.</p>
<p>We will also look at extra base hits:</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>m_protection_extra_base_hit <span class="ot">&lt;-</span> <span class="fu">glm</span>(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  is_extra_base_hit <span class="sc">~</span> batter_xbh_rate <span class="sc">+</span> next_batter_xwOBA <span class="sc">+</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    current_matchup_advantage <span class="sc">+</span> next_matchup_advantage <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    baserunner_state <span class="sc">+</span> outs_when_up <span class="sc">+</span> run_diff <span class="sc">+</span> game_year,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pa_data_final,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> <span class="st">"logit"</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_protection_extra_base_hit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = is_extra_base_hit ~ batter_xbh_rate + next_batter_xwOBA + 
    current_matchup_advantage + next_matchup_advantage + baserunner_state + 
    outs_when_up + run_diff + game_year, family = binomial(link = "logit"), 
    data = pa_data_final)

Coefficients:
                           Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)               -3.441736   0.040563 -84.848  &lt; 2e-16 ***
batter_xbh_rate           13.057888   0.192080  67.981  &lt; 2e-16 ***
next_batter_xwOBA         -0.142683   0.108539  -1.315 0.188651    
current_matchup_advantage  0.135176   0.008168  16.549  &lt; 2e-16 ***
next_matchup_advantage    -0.006115   0.008136  -0.752 0.452340    
baserunner_state1B         0.017441   0.010602   1.645 0.099965 .  
baserunner_state1B-2B      0.006205   0.016541   0.375 0.707566    
baserunner_state1B-3B      0.019531   0.024393   0.801 0.423319    
baserunner_state2B        -0.097752   0.015498  -6.307 2.84e-10 ***
baserunner_state2B-3B     -0.101633   0.029553  -3.439 0.000584 ***
baserunner_state3B        -0.048229   0.025613  -1.883 0.059699 .  
baserunner_stateLoaded     0.088488   0.026673   3.318 0.000908 ***
outs_when_up              -0.046111   0.005006  -9.211  &lt; 2e-16 ***
run_diff                   0.008150   0.001319   6.180 6.42e-10 ***
game_year2016              0.012814   0.016321   0.785 0.432382    
game_year2017             -0.010829   0.016705  -0.648 0.516839    
game_year2018             -0.005318   0.016873  -0.315 0.752632    
game_year2019             -0.007030   0.017236  -0.408 0.683384    
game_year2020             -0.011723   0.029103  -0.403 0.687089    
game_year2021              0.003950   0.017173   0.230 0.818058    
game_year2022              0.011099   0.017279   0.642 0.520644    
game_year2023              0.011634   0.016694   0.697 0.485843    
game_year2024              0.007072   0.017127   0.413 0.679678    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 477885  on 819411  degrees of freedom
Residual deviance: 472591  on 819389  degrees of freedom
AIC: 472637

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Again, the coefficient of <code>next_batter_xwOBA</code> is negative, but insignificant.</p>
<p>These results suggest that the overall offensive effect attributed to lineup protection is not strongly driven by any single offensive outcome. While pitchers may slightly adjust their approach (especially walk likelihood) when facing a strong next batter or easier upcoming matchup, these adjustments do not translate significantly into changes in strikeout, walk, or extra-base hit rates.</p>
<p><strong>Takeaway:</strong> While we see evidence pointing to fewer walks, more strikeouts, and fewer extra base hits with better <code>next_batter_xwOBA</code>, we cannot conclusively point to the next batter’s xwOBA as the cause of these effects.</p>
</section>
</section>
<section id="ii.-increased-interpretability-xba" class="level3">
<h3 class="anchored" data-anchor-id="ii.-increased-interpretability-xba">II. Increased Interpretability: xBA</h3>
<p>In order to increase interpretability, we will also look at the xBA of the current plate appearance. We will use the same model as above, but with <code>pa_xBA</code> as our outcome variable instead of <code>pa_xwOBA</code>. We will also use the xBA of the current batter as our main independent fixed effect, along with the next batter’s strength (as determined by xwOBA). We will also include the batter’s handedness matchup, the next batter’s handedness matchup, the baserunner state, outs when up, run differential, and game year as fixed effects. We will also include random effects for pitcher and batter.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>pa_data_xba <span class="ot">&lt;-</span> pa_data_final <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pa_xBA =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(pa_xBA) <span class="sc">&amp;</span> pa_xwOBA <span class="sc">==</span> <span class="dv">0</span>, <span class="dv">0</span>, pa_xBA)) <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(pa_xBA) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(batter_xBA) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(next_batter_xBA))</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>m_protection_xBA <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  pa_xBA <span class="sc">~</span> batter_xBA <span class="sc">+</span> next_batter_xwOBA <span class="sc">+</span> </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    current_matchup_advantage <span class="sc">+</span> next_matchup_advantage <span class="sc">+</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    baserunner_state <span class="sc">+</span> outs_when_up <span class="sc">+</span> run_diff <span class="sc">+</span> game_year <span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">|</span> pitcher),</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pa_data_xba</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_protection_xBA)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: pa_xBA ~ batter_xBA + next_batter_xwOBA + current_matchup_advantage +  
    next_matchup_advantage + baserunner_state + outs_when_up +  
    run_diff + game_year + (1 | pitcher)
   Data: pa_data_xba

REML criterion at convergence: 276850

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.3726 -0.7915 -0.4387  0.6376  3.0151 

Random effects:
 Groups   Name        Variance  Std.Dev.
 pitcher  (Intercept) 0.0004604 0.02146 
 Residual             0.0851418 0.29179 
Number of obs: 734304, groups:  pitcher, 2347

Fixed effects:
                            Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)                1.295e-02  4.258e-03  4.365e+05   3.041 0.002361 ** 
batter_xBA                 9.887e-01  1.317e-02  7.341e+05  75.094  &lt; 2e-16 ***
next_batter_xwOBA         -2.290e-02  9.388e-03  7.340e+05  -2.440 0.014706 *  
current_matchup_advantage  1.205e-02  7.253e-04  5.687e+05  16.610  &lt; 2e-16 ***
next_matchup_advantage     4.790e-04  7.274e-04  5.498e+05   0.658 0.510262    
baserunner_state1B         5.076e-03  9.161e-04  7.341e+05   5.541 3.01e-08 ***
baserunner_state1B-2B      3.190e-03  1.427e-03  7.343e+05   2.235 0.025400 *  
baserunner_state1B-3B      1.134e-02  2.107e-03  7.341e+05   5.381 7.41e-08 ***
baserunner_state2B        -1.126e-03  1.310e-03  7.341e+05  -0.859 0.390256    
baserunner_state2B-3B     -2.789e-03  2.483e-03  7.341e+05  -1.123 0.261369    
baserunner_state3B        -2.150e-03  2.193e-03  7.340e+05  -0.981 0.326733    
baserunner_stateLoaded     8.590e-03  2.346e-03  7.341e+05   3.662 0.000250 ***
outs_when_up              -5.730e-03  4.299e-04  7.337e+05 -13.328  &lt; 2e-16 ***
run_diff                   4.217e-04  1.153e-04  5.680e+05   3.656 0.000256 ***
game_year2016              1.773e-03  1.445e-03  3.783e+05   1.227 0.219947    
game_year2017              2.521e-03  1.507e-03  2.408e+05   1.673 0.094291 .  
game_year2018              1.790e-03  1.537e-03  1.684e+05   1.165 0.244160    
game_year2019              4.417e-03  1.613e-03  1.400e+05   2.738 0.006173 ** 
game_year2020             -1.605e-03  2.619e-03  3.436e+05  -0.613 0.539805    
game_year2021              3.210e-03  1.623e-03  8.141e+04   1.978 0.047935 *  
game_year2022              3.134e-03  1.635e-03  6.381e+04   1.917 0.055183 .  
game_year2023              4.666e-03  1.624e-03  4.763e+04   2.874 0.004054 ** 
game_year2024              4.729e-03  1.664e-03  3.673e+04   2.841 0.004498 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Correlation matrix not shown by default, as p = 23 &gt; 12.
Use print(x, correlation=TRUE)  or
    vcov(x)        if you need it</code></pre>
</div>
</div>
<p>This model examines how a plate appearance’s batting average metric (<code>pa_xBA</code>) depends on the batter’s season-long average (<code>batter_xBA</code>), the following hitter’s season-long expected wOBA (<code>next_batter_xwOBA</code>), and various other contextual factors. The large positive coefficient on batter_xBA (~0.989) reaffirms that the best predictor of a single PA’s batting outcome is the batter’s own established average. Meanwhile, having a higher <code>next_batter_xwOBA</code> (coefficient ~-0.029) shows a small but statistically significant negative association, indicating the current hitter’s <code>pa_xBA</code> may drop a bit when a stronger hitter is on deck. Some baserunner states (e.g., runner on 1B, 1B-2B, or 1B-#B) slightly increase pa_xBA, others (like runner on 2B alone) decrease it, and having more outs also lowers pa_xBA.</p>
<p><strong>Takeaway:</strong> Even when controlling for batter skill, matchup effects, and game state, a higher next_batter_xwOBA is associated with a small but statistically significant decrease in the current batter’s expected batting average (xBA) for that plate appearance. If the next batter’s xwOBA goes up by 0.100, we estimate a ~-0.003 reduction in pa_xBA per plate appearance—over 500 plate appearances, that amounts to about 1.5 fewer hits compared to otherwise.</p>
</section>
<section id="iii.-model-selection-of-the-overall-offensive-output" class="level3">
<h3 class="anchored" data-anchor-id="iii.-model-selection-of-the-overall-offensive-output">III. Model Selection of the Overall Offensive Output</h3>
<p>Let’s return to our <code>m_protection_slope</code> model and see if we can improve it with model selection. Using the <code>drop1</code> function, which uses F-tests with Satterthwaite’s approximation for degrees of freedom to see what would happen to model fit if we removed each fixed effect one at a time, we get the following results.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">drop1</span>(m_protection_slope, <span class="at">test =</span> <span class="st">"Chisq"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Single term deletions using Satterthwaite's method:

Model:
pa_xwOBA ~ batter_xwOBA + next_batter_xwOBA + current_matchup_advantage + next_matchup_advantage + baserunner_state + outs_when_up + run_diff + game_year + ((1 | pitcher_year) + (0 + next_batter_xwOBA | pitcher_year))
                          Sum Sq Mean Sq NumDF  DenDF   F value    Pr(&gt;F)    
batter_xwOBA              910.99  910.99     1 622176 6286.5539 &lt; 2.2e-16 ***
next_batter_xwOBA           0.81    0.81     1 125767    5.5630   0.01835 *  
current_matchup_advantage  52.83   52.83     1 370579  364.5597 &lt; 2.2e-16 ***
next_matchup_advantage      0.11    0.11     1 332189    0.7769   0.37810    
baserunner_state            2.51    0.36     7 621854    2.4699   0.01562 *  
outs_when_up                7.28    7.28     1 621657   50.2323 1.367e-12 ***
run_diff                    0.05    0.05     1 446802    0.3725   0.54165    
game_year                   0.65    0.07     9   2584    0.5008   0.87484    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>As expected, <code>batter_xwOBA</code> is incredibly important to the model, along with <code>current_matchup_advantage</code>. <code>next_batter_xwOBA</code>, <code>outs_when_up</code>, and <code>baserunner_state</code> are also important, while <code>next_matchip_advantage</code>, <code>run_diff</code>, and <code>game_year</code> are not.</p>
<p>Let’s create a final model with just the most important fixed effects. We will also include the random slope for the next batter’s xwOBA.</p>
<div class="cell">
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>m_protection_final <span class="ot">&lt;-</span> <span class="fu">lmer</span>(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  pa_xwOBA <span class="sc">~</span> batter_xwOBA <span class="sc">+</span> next_batter_xwOBA <span class="sc">+</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    current_matchup_advantage <span class="sc">+</span> </span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    baserunner_state <span class="sc">+</span> outs_when_up <span class="sc">+</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="sc">+</span> next_batter_xwOBA <span class="sc">||</span> pitcher_year),  <span class="co"># uncorrelated random effects</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> pa_filtered</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in checkConv(attr(opt, "derivs"), opt$par, ctrl = control$checkConv, :
Model failed to converge with max|grad| = 0.00623311 (tol = 0.002, component 1)</code></pre>
</div>
<details class="code-fold">
<summary>Show Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_protection_final)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML. t-tests use Satterthwaite's method [
lmerModLmerTest]
Formula: 
pa_xwOBA ~ batter_xwOBA + next_batter_xwOBA + current_matchup_advantage +  
    baserunner_state + outs_when_up + (1 + next_batter_xwOBA ||  
    pitcher_year)
   Data: pa_filtered

REML criterion at convergence: 565887.3

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-1.3680 -0.7696 -0.3876  0.7056  4.7366 

Random effects:
 Groups         Name              Variance  Std.Dev.
 pitcher_year   (Intercept)       0.0003593 0.01896 
 pitcher_year.1 next_batter_xwOBA 0.0028778 0.05365 
 Residual                         0.1449103 0.38067 
Number of obs: 622199, groups:  pitcher_year, 2876

Fixed effects:
                            Estimate Std. Error         df t value Pr(&gt;|t|)    
(Intercept)                8.100e-05  5.440e-03  2.220e+05   0.015 0.988120    
batter_xwOBA               1.018e+00  1.280e-02  6.188e+05  79.544  &lt; 2e-16 ***
next_batter_xwOBA         -3.083e-02  1.333e-02  1.332e+05  -2.313 0.020733 *  
current_matchup_advantage  1.921e-02  9.856e-04  5.109e+05  19.487  &lt; 2e-16 ***
baserunner_state1B         1.540e-03  1.304e-03  6.220e+05   1.181 0.237718    
baserunner_state1B-2B      9.825e-04  2.077e-03  6.222e+05   0.473 0.636239    
baserunner_state1B-3B      2.766e-03  3.079e-03  6.221e+05   0.899 0.368883    
baserunner_state2B         6.140e-03  1.842e-03  6.221e+05   3.334 0.000857 ***
baserunner_state2B-3B     -1.358e-03  3.558e-03  6.221e+05  -0.382 0.702700    
baserunner_state3B         7.146e-03  3.084e-03  6.221e+05   2.317 0.020524 *  
baserunner_stateLoaded    -2.701e-03  3.592e-03  6.218e+05  -0.752 0.452108    
outs_when_up              -4.307e-03  6.086e-04  6.216e+05  -7.077 1.47e-12 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Correlation of Fixed Effects:
            (Intr) bt_OBA n__OBA crrn__ bsr_1B b_1B-2 b_1B-3 bsr_2B b_2B-3
battr_xwOBA -0.569                                                        
nxt_btt_OBA -0.607 -0.253                                                 
crrnt_mtch_ -0.122  0.035 -0.004                                          
bsrnnr_st1B -0.026 -0.019  0.007  0.005                                   
bsrnn_1B-2B -0.019 -0.009  0.015  0.010  0.160                            
bsrnn_1B-3B -0.009 -0.005  0.007  0.009  0.109  0.074                     
bsrnnr_st2B -0.009 -0.008  0.001  0.005  0.180  0.120  0.082              
bsrnn_2B-3B -0.013  0.006  0.003  0.009  0.095  0.064  0.044  0.072       
bsrnnr_st3B  0.005 -0.004 -0.002  0.006  0.113  0.077  0.054  0.088  0.047
bsrnnr_sttL -0.016  0.004  0.008  0.011  0.094  0.064  0.044  0.071  0.039
outs_when_p -0.211 -0.007  0.015  0.006 -0.107 -0.115 -0.089 -0.131 -0.078
            bsr_3B bsrn_L
battr_xwOBA              
nxt_btt_OBA              
crrnt_mtch_              
bsrnnr_st1B              
bsrnn_1B-2B              
bsrnn_1B-3B              
bsrnnr_st2B              
bsrnn_2B-3B              
bsrnnr_st3B              
bsrnnr_sttL  0.046       
outs_when_p -0.126 -0.077
optimizer (nloptwrap) convergence code: 0 (OK)
Model failed to converge with max|grad| = 0.00623311 (tol = 0.002, component 1)</code></pre>
</div>
</div>
<p>In our final model, all coefficients, except for the different levels of <code>baserunner_state</code>, are significant. The coefficient of <code>next_batter_xwOBA</code> is -0.03083, and is signficant at the <span class="math inline">\(\alpha\)</span> = 0.05 level, with a p-value of 0.02. This indicates that the next batter’s xwOBA does have a small but significant impact on the current plate appearance’s xwOBA, and this effect is negative.</p>
<p><strong>Takeaway:</strong> When we select certain fixed effects, we find that the next batter’s xwOBA continue to have a small but significant impact on the current plate appearance’s xwOBA, and this effect is negative. A stronger on-deck hitter results in lower than expected outcomes for that plate appearance.</p>
</section>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">Discussion</h2>
<p>This study, although rather simple, tackles some of the problems with sabermetrics’ view of lineup protection. By accounting for different game situations, we find that the skill of the next batter does have a statistically significant impact on the offensive outcomes of the current one. While small, this will have significant implications for player evaluation and valuation, as we are establishing dependencies between players that have not been accounted for in the past. We also importantly incorporate the current baserunner situation, number of outs, and current batter handedness advantages, which proved signficant. These all point to the idea that simulations of baseball lineups should both include game situation states and the next batter’s skill in order to get a more accurate picture of the current batter’s expected outcomes. Each batter does not come up as an indepdent entity with a unique and stationary probability distribution of their outcomes, but rather a probability distribution slightly altered by externalities.</p>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<p>Ambrosino,&nbsp;D. (2011, November 30). <em>Orders of protection</em>. The Hardball Times. <a href="https://tht.fangraphs.com/orders-of-protection/" class="uri">https://tht.fangraphs.com/orders-of-protection/</a></p>
<p>Bradbury,&nbsp;J.&nbsp;C., &amp; Drinen,&nbsp;D.&nbsp;J. (2007). Pigou at the plate. <em>Journal of Sports Economics</em>, <em>9</em>(2), 211-224. <a href="https://doi.org/10.1177/1527002507300178" class="uri">https://doi.org/10.1177/1527002507300178</a></p>
<p>Britton,&nbsp;T. (2024, April 26). J.D. Martinez will be Pete Alonso’s protection in Mets lineup. Does that matter? <em>The New York Times</em>. <a href="https://www.nytimes.com/athletic/5443604/2024/04/26/mets-pete-alonso-jd-martinez-lineup/" class="uri">https://www.nytimes.com/athletic/5443604/2024/04/26/mets-pete-alonso-jd-martinez-lineup/</a></p>
<p>Cameron,&nbsp;D. (2012, May 25). <em>Cameron: McCutchen disproves lineup protection</em>. ESPN.com. <a href="https://insider.espn.com/mlb/insider/story/_/id/7970598/andrew-mccutchen-another-example-why-lineup-protection-myth-mlb" class="uri">https://insider.espn.com/mlb/insider/story/_/id/7970598/andrew-mccutchen-another-example-why-lineup-protection-myth-mlb</a></p>
<p>How to quantify lineup protection in baseball — The Paraball notes. (2024, April 9). <em>The Paraball Notes</em>. <a href="https://www.paraballnotes.com/blog/how-to-quantify-lineup-protection-in-baseball" class="uri">https://www.paraballnotes.com/blog/how-to-quantify-lineup-protection-in-baseball</a></p>
<p>Laurila,&nbsp;D. (2016, July 14). <em>Player’s view: Does lineup protection exist?</em> FanGraphs Baseball. <a href="https://blogs.fangraphs.com/players-view-does-lineup-protection-exist/" class="uri">https://blogs.fangraphs.com/players-view-does-lineup-protection-exist/</a></p>
<p>Petriello,&nbsp;M. (2015, April 13). <em>Billy Hamilton’s reverse lineup protection</em>. FanGraphs Baseball. <a href="https://blogs.fangraphs.com/billy-hamiltons-reverse-lineup-protection/" class="uri">https://blogs.fangraphs.com/billy-hamiltons-reverse-lineup-protection/</a></p>
<p>Phillips,&nbsp;D.&nbsp;C. (2011). You’re hurting my game: Lineup protection and injuries in Major League Baseball. <em>Journal of Quantitative Analysis in Sports</em>, <em>7</em>(3). <a href="https://doi.org/10.2202/1559-0410.1296" class="uri">https://doi.org/10.2202/1559-0410.1296</a></p>
<p>Stavenhagen,&nbsp;C. (2019, May 7). The (latest) numbers behind Miguel Cabrera’s remarks on lineup protection. <em>The New York Times</em>. <a href="https://www.nytimes.com/athletic/965467/2019/05/07/the-latest-numbers-behind-miguel-cabreras-remarks-on-lineup-protection/" class="uri">https://www.nytimes.com/athletic/965467/2019/05/07/the-latest-numbers-behind-miguel-cabreras-remarks-on-lineup-protection/</a></p>
<p>Tango,&nbsp;T. (2006, April 7). <em>Pitching around batters</em>. The Hardball Times. <a href="https://tht.fangraphs.com/pitching-around-batters/" class="uri">https://tht.fangraphs.com/pitching-around-batters/</a></p>
<p>Weinberg,&nbsp;N. (2013, January 1). <em>Lineup protection: Fact or fiction?</em> New English D. <a href="https://newenglishd.com/2013/01/01/lineup-protection-fact-or-fiction/" class="uri">https://newenglishd.com/2013/01/01/lineup-protection-fact-or-fiction/</a></p>
<p>Wiser,&nbsp;J. (2014, February 19). <em>Let’s talk about lineup protection</em>. Inside the ’Zona. <a href="https://insidethezona.com/2014/02/lets-talk-lineup-protection/" class="uri">https://insidethezona.com/2014/02/lets-talk-lineup-protection/</a></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>© 2025. All rights reserved.</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>